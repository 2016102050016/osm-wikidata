<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>OSM ◀ ▶ Wikidata</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='bootstrap4/css/bootstrap.css') }}">
  <style>
    .box {
      border: 1px solid black;
      margin: 4px;
      padding: 4px;
    }
  </style>
</head>
{% set detail = 0 %}

<body>
  <div class="container-fluid">
  <div class="row">
  <div class="col">
    <h1>OSM ◀ ▶ Wikidata</h1>

  {% include "form.html" %}
  {% if not q and existing %}
    <table class="table table-hover table-sm" style="width: auto">
      <thead>
        <tr>
          <th><a href="{{ sort_link('name') }}">name</a></th>
          <th class="text-right"><a href="{{ sort_link('item') }}">item<br>count</a></th>
          <th class="text-right"><a href="{{ sort_link('match') }}">match<br>count</a></th>
          <th class="text-right"><a href="{{ sort_link('ratio') }}">match<br>ratio</a></th>
          <th class="text-right"><a href="{{ sort_link('area') }}">area<br>(km&sup2;)</a></th>
        </tr>
      <tbody>
      {% for place in existing %}
        {% set with_candidates_count = place.items_with_candidates_count() %}
        <tr>
          <td>
            {% if place.state == 'overpass_timeout' %}
              {{ place.display_name }} <span class="badge badge-danger">area too large</span>
            {% else %}
              <a href="{{ place.candidates_url() }}">{{ place.display_name }}</a>
            {% endif %}
          </td>
          <td class="text-right">{{ place.items.count() }}</td>
          <td class="text-right">{{ with_candidates_count or '' }}</td>
          <td class="text-right">
          {% if place.items.count() and with_candidates_count %}
            {{ '{:.1%}'.format(place.match_ratio) }}
          {% endif %}
          <td class="text-right">
            {{ '{:,.1f}'.format(place.area_in_sq_km) }}
          </td>
          </td>
        </tr>
        {# <tr>
          <td colspan="2"><pre>{{ item | pprint }}</pre></td>
        </tr> #}
      {% endfor %}
      </tbody>
    </table>
  {% endif %}

  {% if q %}
  {% if results | count == 0 %}
    <p>no matches found</p>
  {% endif %}
  {% for hit in results %}
    <div class="box">
      {# {% set name = hit.namedetails["name:en"] or hit.namedetails["name"] %} #}
      {% if hit.icon %}<img src="{{ hit.icon }}">{% endif %}
      {% if hit.osm_type == 'relation' %}
        <b>
          {% if name %}
            <a href="{{ url_for('matcher_progress', osm_id=hit.osm_id) }}">{{ name }}</a>,
            {% if hit.address.state %}{{ hit.address.state }}, {% endif %}
            {{ hit.address.country }}
          {% else %}
            <a href="{{ url_for('matcher_progress', osm_id=hit.osm_id) }}">{{ hit.display_name }}</a>
          {% endif %}
        </b><br>
      {% else %}
        <b>
        {% if name %}
          {{ name }}, {{ hit.address.state }}, {{ hit.address.country }}
        {% else %}
          {{ hit.display_name }}
        {% endif %}
        </b><br>
        [matcher only works with OSM relations]<br>
      {% endif %}
      category: {{ hit.category }}
      &mdash;
      type: {{ hit.type }}<br>
      bounding box: {{ ', '.join(hit.boundingbox) }}<br>
      {% if hit.place %}
        area: {{ '{:.2f}'.format(hit.place.area_in_sq_km) }} km&sup2; <br>
      {% endif %}
      OSM: <a href="https://www.openstreetmap.org/{{ hit.osm_type }}/{{ hit.osm_id }}">{{ hit.osm_type}} {{ hit.osm_id }}</a><br>
      {% if detail %}
        importance: {{ hit.importance }}<br>
        <pre>{{ hit.address | pprint }}</pre>
        <pre>{{ hit.extratags | pprint }}</pre>
        <pre>{{ hit | pprint }}</pre>
      {% endif %}
    </div>
  {% endfor %}
  {% endif %}

</div>
</div>
</div>
</body>
</html>
