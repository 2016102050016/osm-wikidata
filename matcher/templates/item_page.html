{% macro candidate_info(c, upload_option) %}
  {% set m = c.get_match() %}
  <li>
    {% if 'wikidata' not in c.tags and upload_option %}
      <input type="radio" name="{{ osm }}" value="{{ c.osm_type }}/{{ c.osm_id }}">
    {% endif %}
    <a href="https://www.openstreetmap.org/{{ c.osm_type }}/{{ c.osm_id }}">
      {{ (m.osm_key + '=' + m.osm_name) if m else c.name }}
    </a>
    ({{ c.osm_type}}{% if c.dist %},
     {{ c.dist | int }} m{% endif %})
     {{ ', '.join(c.matching_tags()) }}

     <a href="#" class="show_tags_link" data-key="{{ c.key }}">show all tags</a>
     <div class="all_tags" id="candidate{{ c.key }}">
       {% for k, v in c.tags.items() if k != 'way_area' %}
        {{ k }}: {{ v }}</br>
       {% endfor %}
     </div>
     {% if 'wikidata' in c.tags %}
       <br>
       {% if c.tags.wikidata == c.item.qid %}
         wikidata <span class="match">match</span>: {{ c.tags.wikidata }}
       {% else %}
         wikidata <span class="mismatch">mismatch</span>: <a href="https://www.wikidata.org/wiki/{{ c.tags.wikidata }}">{{ c.tags.wikidata }}</a>
       {% endif %}
     {% endif %}
    </li>
{% endmacro %}

{% extends "base.html" %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='leaflet/leaflet.css') }}">
<style>
#mapid { height: 400px; }
</style>
{% endblock %}

{% block script %}
  {% if lat and lon %}
  <script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>

  <script>
    var lat = {{ '{:.4f}'.format(lat) }};
    var lon = {{ '{:.4f}'.format(lon) }};
    var map = L.map('mapid').setView([lat, lon], 18);

    L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    var marker = L.marker([lat, lon]).addTo(map);

  </script>
  {% endif %}

{% endblock %}

{% block content %}
<div class="m-3">
  <div class="container">
    {% include "flash_msg.html" %}

    <h1>{{ label }} ({{ qid }})</h1>
    <ul>
      {% if item %}
      <li>matcher place:
        {% for place in item.places %}
            <a href="{{ place.candidates_url() }}">{{ place.name }}</a> ({{ place.osm_type }} {{ place.osm_id }})
            {%- if not loop.last %}, {% endif %}
        {% endfor %}
      </li>
      {% endif %}
      <li><a href="http://wikidata.org/wiki/{{ qid }}">view on Wikidata</a></li>
      <li><a href="http://query.wikidata.org/#{{ wikidata_query | urlencode }}">Wikidata query</a></li>
      {% if lat and lon %}
      <li>Wikidata coordinates: {{ '{:.4f}'.format(lat) }}, {{ '{:.4f}'.format(lon) }}
        <a href="https://www.openstreetmap.org/#map=18/{{ lat }}/ {{ lon }}">view on OSM</a>
      </li>
      {% else %}
      <li>no coordinates for item</li>
      {% endif %}

      {% if sitelinks %}
      <li>Wikipedia:
          {% for link in sitelinks %}<a href="{{ link.url }}">{{ link.lang }}</a>
{%- if not loop.last %}, {% endif %}{% endfor %}
      </li>
      {% endif %}
      {% if 'commonswiki' in entity.sitelinks %}
      <li><a href="https://commons.wikimedia.org/wiki/{{ entity.sitelinks.commonswiki.title.replace(' ', '_') }}">Wikimedia Commons</a>
      </li>
      {% endif %}

      {% if item and item.categories %}
        <li>English Wikipedia categories:
        {% for cat in item.categories %}
            <a href="https://en.wikipedia.org/wiki/Category:{{ cat.replace(' ', '_') }}">{{ cat }}</a>{% if not loop.last %},{% endif %}
        {% endfor %}
        </li>
      {% endif %}

      {% if oql %}
      <li>Overpass query:
        <a href="#" id="oql-toggle">show query</a>
        &ndash;
        <a href="https://overpass-turbo.eu/?Q={{ oql.replace('qt center tags', 'geom') | urlencode }}&R">Overpass Turbo</a>
        <pre id="oql">{{ oql }}</pre>
      </li>
      {% endif %}

    </ul>

    <div id="mapid"></div>

    {#

    <h3>labels</h3>
    <pre>{{ entity['labels'] | pprint }}</pre>
    {% if entity.aliases %}
      <h3>aliases</h3>
      <pre>{{ entity.aliases | pprint }}</pre>
    {% endif %}
    <h3>site links</h3>
    <pre>{{ entity.sitelinks | pprint }}</pre>

    <h3>wikidata names</h3>
    <pre>{{ wikidata_names | pprint }}</pre>

    #}

    {% if overpass_reply and not found %}
        <h3>overpass result</h3>
        {% if overpass_reply['elements'] | count > 10 %}
            <p>more than 10 results</p>
        {% else %}
            <pre>{{ overpass_reply['elements'] | pprint }}</pre>
        {% endif %}
    {% endif %}

    <h3>matches</h3>
    {% if upload_option %}
    <form method="post" action="{{ url_for('add_wikidata_tag') }}">
      <button class="btn btn-primary">add wikidata tag to OpenStreetMap</button>
      <input type="hidden" name="wikidata" value="{{ qid }}" />
    {% endif %}
    {% if item %}

      {% if not g.user.is_authenticated %}
        <p><a class="btn btn-primary" href="{{ url_for('social.auth', backend='openstreetmap', next=request.script_root + request.full_path) }}">login to upload wikidata tags</a></p>
      {% endif %}


      {% for c in item.candidates %}
        {{ candidate_info(c, upload_option) }}
      {% endfor %}
    {% else %}
      {% if not found %}
          <p>no matches found</p>
      {% else %}
        <ul>
        {% for c, m in found %}
          <li>
            {% if 'wikidata' not in c.tags and upload_option %}
              <input type="radio" name="{{ osm }}" value="{{ c.osm_type }}/{{ c.osm_id }}">
            {% endif %}
            <a href="https://www.openstreetmap.org/{{ c.type }}/{{ c.id }}">
            {{ (m.osm_key + '=' + m.osm_name) if m else c.tags.name }}
          </a> ({{ c.type}})

           <a href="#" class="show_tags_link" data-key="{{ c.key }}">show all tags</a>
           <div class="all_tags" id="candidate{{ c.key }}">
             {% for k, v in c.tags|dictsort %}
              {{ k }}={{ v }}</br>
             {% endfor %}
           </div>
          {% if 'wikidata' in c.tags %}
            <p>OSM already includes wikidata tag.</p>
          {% endif %}
           </li>

        {% endfor %}
        </ul>
      {% endif %}
    {% endif %}

    {% if upload_option %}
      <label for="comment">change comment:</label>
      <input class="form-control m-2"
             id="comment"
             name="comment"
             size="40"
             value="add wikidata tag to {{ label }}" />

      <button class="btn btn-primary">add wikidata tag to OpenStreetMap</button>
      </form>
    {% endif %}

    {% if osm_keys %}

    <h3 class="my-2">Search criteria from Wikidata</h3>
    <table class="table table-responsive table-hover table-sm">
    {% for row in osm_keys %}
      <tr>
        <td>{{ row['item']['value'] }}</td>
        <td>{{ row['itemLabel']['value'] }}</td>
        <td>{{ row['tag']['value'] }}</td>
    {% endfor %}
    </table>
    {% endif %}

    {% if category_map %}
    <h3>Search criteria from categories</h3>
    <table class="table table-responsive table-hover table-sm">
    {% for cat, tags in category_map | dictsort %}
      <tr>
        <td>
          <a href="https://en.wikipedia.org/wiki/Category:{{ cat.replace(' ', '_') }}">{{ cat }}</a>
        </td>
        <td>
          {% for tag in tags %}
            {{ tag }}<br>
          {% endfor %}
        </td>
      </tr>
    {% endfor %}
    </table>
    {% endif %}


  </div>
</div>
{% endblock %}
