{% from "macro.html" import place_box %}
{% extends "base.html" %}

{% block title %}{{ place.display_name }}:{% endblock %}

{% block content %}
  <div class="container my-2">
  <div class="row">
  <div class="col">
    <h1>{{ place.name }}</h1>
  {% set q = place.display_name %}

  {{ place_box(place) }}

  {% include "tabs.html" with context %}

  {% if overpass_error %}
    <div>&nbsp;</div>
    <h4>Overpass API error</h4>
    <pre>{{ overpass_error }}</pre>
  {% else %}
    <p>
    {{ '{:,d}'.format(full_count) }} candidates found
    ({{ '{:,d}'.format(multiple_match_count) }} with multiple matches)
    </p>
    {% set url = url_for('export_osm', osm_id=place.osm_id, name=place.export_name) %}
    <p><a href="{{ url }}">Download as OSM XML file</a></p>
  {% endif %}

  {% if not overpass_error and candidates %}
    {% if multiple_only %}
      <p>[Filter: <b>only multiple</b> <a href="{{ place.candidates_url() }}">(remove)</a>]
    {% else %}
      <p>[Filter: <a href="{{ place.candidates_url(multiple=1) }}">only multiple matches</a>]
    {% endif %}
  {% endif %}
  </div>
  </div>

  {% if candidates %}

    <form method="POST">

    {% for i in candidates %}
      <p>
      {% if g.user.is_authenticated %}
        {% if i.item_id in filtered %}
          <input type="checkbox" name="include" value="{{ i.qid }}" checked="checked" />
        {% else %}
          <input type="checkbox" disabled="disabled" />
        {% endif %}
      {% endif %}
      <a href="{{ url_for('item_page', wikidata_id=i.qid[1:]) }}">{{ i.enwiki }} ({{ i.qid }})</a></p>
      {# <br>
      <ul>
        <li>Categories:
        {% for cat in i.categories %}
            <a href="https://en.wikipedia.org/wiki/Category:{{ cat.replace(' ', '_') }}">{{ cat }}</a>{% if not loop.last %},{% endif %}
        {% endfor %}
        </li>
        <li>tags considered: {{ ', '.join(i.tags) }}</li>
      </ul> #}
      <ul>
      {% for c in i.candidates %}
      {% set m = c.get_match() %}
        <li><a href="https://www.openstreetmap.org/{{ c.osm_type }}/{{ c.osm_id }}">
          {{ (m.osm_key + '=' + m.osm_name) if m else c.name }}
        </a>
        ({{ c.osm_type}}{% if c.dist %},
         {{ c.dist | int }} m{% endif %})
         {{ ', '.join(c.matching_tags()) }}
         {% if i.item_id in filtered and c == filtered[i.item_id] %}
           <span class="highlight">best match</span>
         {% endif %}
        </li>
      {% endfor %}
      </ul>
    {% endfor %}

  {% else %}

  {% endif %}

</div>
</div>
</div>
{% endblock %}
